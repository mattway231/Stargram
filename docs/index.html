<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stargram</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="/static/css/main.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app" class="app dark-theme">
        <!-- Header -->
        <header class="glass">
            <div class="user-info" @click="toggleProfileMenu">
                <div class="avatar" :style="{'background': getAvatarColor(user.avatar_color)}">
                    {{ user.name.charAt(0) }}
                </div>
                <div class="username">{{ user.name }}</div>
            </div>
            <div class="profile-menu glass" v-if="profileMenuOpen">
                <div class="menu-item" @click="logout">Выйти</div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container">
            <!-- Home Page -->
            <div v-if="currentPage === 'home'" class="page home-page">
                <!-- GPT Section -->
                <section class="card glass">
                    <div class="section-header">
                        <h3>GPT-4o</h3>
                    </div>
                    <div class="input-group">
                        <input type="text" v-model="gptPrompt" placeholder="Написать нейросети" 
                               @keyup.enter="sendToGPT">
                        <button class="btn primary" :disabled="!gptPrompt" @click="sendToGPT">
                            <i class="icon-send"></i>
                        </button>
                    </div>
                </section>

                <!-- Report Section -->
                <section class="card glass">
                    <div class="section-header">
                        <h3>Пожаловаться на игрока</h3>
                    </div>
                    <p class="section-description">
                        Отправь ссылку на сообщение с нарушением и получи 6000❇️
                    </p>
                    <div class="input-group">
                        <input type="text" v-model="reportLink" placeholder="Ссылка на сообщение">
                        <button class="btn primary" @click="sendReport" :disabled="!reportLink || user.nova_balance < 5000">
                            5000❇️
                        </button>
                    </div>
                    <p class="hint-text">
                        Жалоба стоит 5000❇️. При подтверждении нарушения получишь 6000❇️
                    </p>
                    <div v-if="reportResult" class="report-result" :class="reportResult.type">
                        {{ reportResult.message }}
                    </div>
                </section>

                <!-- Balance Section -->
                <section class="balance-section">
                    <div class="section-header">
                        <h3>Баланс</h3>
                    </div>
                    <div class="card glass balance-card">
                        <div class="balance-item">
                            <span class="currency nova">$NOVA</span>
                            <span class="amount">{{ user.nova_balance }}❇️</span>
                        </div>
                        <div class="balance-item">
                            <span class="currency tix">$TIX</span>
                            <span class="amount">{{ user.tix_balance }}✴️</span>
                        </div>
                    </div>
                </section>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="action-btn" @click="openModal('exchange')">
                        <i class="icon-exchange"></i>
                        <span>Обменять</span>
                    </button>
                    <button class="action-btn" @click="currentPage = 'shop'">
                        <i class="icon-cart"></i>
                        <span>Купить</span>
                    </button>
                    <button class="action-btn" @click="openModal('gift')">
                        <i class="icon-gift"></i>
                        <span>Подарить</span>
                    </button>
                </div>

                <!-- Members Section -->
                <section class="members-section">
                    <div class="section-header">
                        <h3>Участники</h3>
                        <div class="sort-dropdown">
                            <button class="sort-btn" @click="toggleSortDropdown">
                                <i class="icon-sort"></i> {{ sortOptions[selectedSort].label }}
                            </button>
                            <div class="dropdown-menu glass" v-if="sortDropdownOpen">
                                <div v-for="(option, index) in sortOptions" :key="index" 
                                     @click="sortMembers(index)" 
                                     :class="{active: selectedSort === index}">
                                    {{ option.label }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="members-list">
                        <div v-for="member in sortedMembers" :key="member.id" class="member-card glass">
                            <div class="member-avatar" :style="{'background': getAvatarColor(member.avatar_color)}">
                                {{ member.name.charAt(0) }}
                            </div>
                            <div class="member-info">
                                <div class="member-name">{{ member.name }}</div>
                                <div class="member-username">{{ member.username }}</div>
                            </div>
                            <div class="member-balance">
                                <div class="balance-badge nova">{{ member.nova_balance }}❇️</div>
                                <div class="balance-badge tix">{{ member.tix_balance }}✴️</div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- AI Page -->
            <div v-if="currentPage === 'ai'" class="page ai-page">
                <div class="ai-header glass">
                    <button class="back-btn" @click="currentPage = 'home'">
                        <i class="icon-arrow-left"></i>
                    </button>
                    <h3>{{ currentAIModel }}</h3>
                    <button class="new-chat-btn" @click="newChat">
                        <i class="icon-plus"></i>
                    </button>
                </div>

                <div class="ai-sidebar glass" :class="{open: sidebarOpen}">
                    <div class="sidebar-header">
                        <h4>Модели</h4>
                    </div>
                    <div class="model-list">
                        <div v-for="model in aiModels" :key="model.id" 
                             class="model-item" 
                             :class="{active: currentAIModel === model.name}"
                             @click="selectModel(model)">
                            <i :class="model.icon"></i>
                            <span>{{ model.name }}</span>
                        </div>
                    </div>

                    <div class="sidebar-header">
                        <h4>Чаты</h4>
                    </div>
                    <div class="chat-list">
                        <div v-for="chat in aiChats" :key="chat.id" 
                             class="chat-item"
                             :class="{active: currentChat === chat.id}"
                             @click="loadChat(chat.id)">
                            <div class="chat-title">{{ chat.title }}</div>
                        </div>
                    </div>
                </div>

                <div class="ai-chat-container">
                    <div class="ai-messages" ref="messagesContainer">
                        <div v-for="message in currentMessages" :key="message.id" 
                             class="message" :class="message.role">
                            <div class="message-content">{{ message.content }}</div>
                        </div>
                    </div>

                    <div class="ai-input-container glass">
                        <div v-if="currentAIModel === 'YaART Image'" class="image-options">
                            <select v-model="imageFormat">
                                <option value="horizontal">Горизонтальный</option>
                                <option value="vertical">Вертикальный</option>
                                <option value="square">Квадратный</option>
                            </select>
                            <select v-model="imageStyle">
                                <option v-for="style in imageStyles" :value="style.value">
                                    {{ style.label }}
                                </option>
                            </select>
                        </div>
                        <div v-if="currentAIModel.includes('Video')" class="video-options">
                            <select v-model="videoLength">
                                <option value="5">5 секунд</option>
                                <option value="10">10 секунд</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <input type="text" v-model="aiPrompt" placeholder="Введите запрос..." 
                                   @keyup.enter="sendAIRequest">
                            <button class="btn primary" @click="sendAIRequest" 
                                    :disabled="!aiPrompt || (currentAIModel !== 'GPT-4o' && user.tix_balance < getAICost())">
                                {{ getAICost() }}✴️
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- StarMap Page -->
            <div v-if="currentPage === 'starmap'" class="page starmap-page">
                <div id="map-container" v-if="locationAllowed">
                    <div class="map-controls">
                        <button class="map-btn" @click="toggleStepsRanking">
                            <i class="icon-steps"></i>
                            <span>Шаги</span>
                        </button>
                        <button class="map-btn" @click="togglePointsList">
                            <i class="icon-points"></i>
                            <span>Точки</span>
                        </button>
                        <button class="map-btn" @click="toggleProfileStats">
                            <i class="icon-profile"></i>
                            <span>Профиль</span>
                        </button>
                    </div>

                    <div class="steps-ranking glass" v-if="stepsRankingOpen">
                        <div class="ranking-header">
                            <h4>Рейтинг по шагам</h4>
                            <button @click="stepsRankingOpen = false">
                                <i class="icon-close"></i>
                            </button>
                        </div>
                        <div class="ranking-tabs">
                            <button :class="{active: stepsPeriod === 'day'}" 
                                    @click="stepsPeriod = 'day'">День</button>
                            <button :class="{active: stepsPeriod === 'week'}" 
                                    @click="stepsPeriod = 'week'">Неделя</button>
                        </div>
                        <div class="ranking-list">
                            <div v-for="(user, index) in stepsRanking" :key="user.id" class="ranking-item">
                                <div class="rank">
                                    <span v-if="index < 3">{{ ['🥇', '🥈', '🥉'][index] }}</span>
                                    <span v-else>{{ index + 1 }}.</span>
                                </div>
                                <div class="user-info">
                                    <div class="user-avatar" 
                                         :style="{'background': getAvatarColor(user.avatar_color)}">
                                        {{ user.name.charAt(0) }}
                                    </div>
                                    <div class="user-name">{{ user.name }}</div>
                                </div>
                                <div class="steps-count">{{ user.steps }} шагов</div>
                            </div>
                        </div>
                    </div>

                    <div class="points-list glass" v-if="pointsListOpen">
                        <div class="points-header">
                            <h4>Мои точки</h4>
                            <button @click="pointsListOpen = false">
                                <i class="icon-close"></i>
                            </button>
                        </div>
                        <div class="points-items">
                            <div v-for="point in userPoints" :key="point.id" class="point-item">
                                <div class="point-icon">📍</div>
                                <div class="point-info">
                                    <div class="point-address">{{ point.address }}</div>
                                    <div class="point-time">До {{ point.expires }}</div>
                                </div>
                                <button class="navigate-btn" @click="navigateToPoint(point)">
                                    <i class="icon-navigate"></i>
                                </button>
                            </div>
                            <div v-for="point in collectedPoints" :key="'collected-'+point.id" 
                                 class="point-item collected">
                                <div class="point-icon">🌟</div>
                                <div class="point-info">
                                    <div class="point-address">{{ point.address }}</div>
                                    <div class="point-reward">+{{ point.reward }}❇️</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="profile-stats glass" v-if="profileStatsOpen">
                        <div class="profile-header">
                            <div class="profile-avatar" 
                                 :style="{'background': getAvatarColor(user.avatar_color)}">
                                {{ user.name.charAt(0) }}
                            </div>
                            <div class="profile-name">{{ user.name }}</div>
                            <div class="profile-username">{{ user.username }}</div>
                            <button @click="profileStatsOpen = false">
                                <i class="icon-close"></i>
                            </button>
                        </div>
                        <div class="stats-tabs">
                            <button :class="{active: statsPeriod === 'day'}" 
                                    @click="statsPeriod = 'day'">День</button>
                            <button :class="{active: statsPeriod === 'week'}" 
                                    @click="statsPeriod = 'week'">Неделя</button>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value">{{ stats.steps }}</div>
                                <div class="stat-label">Шаги</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ stats.points }}</div>
                                <div class="stat-label">Точки</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ stats.nova_earned }}❇️</div>
                                <div class="stat-label">Заработано</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ stats.ranking }}</div>
                                <div class="stat-label">Место</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else class="location-permission">
                    <div class="permission-card glass">
                        <h3>Доступ к геолокации</h3>
                        <p>Для работы StarMap необходимо разрешить доступ к вашей геолокации</p>
                        <button class="btn primary" @click="requestLocationAccess">
                            Разрешить доступ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Shop Page -->
            <div v-if="currentPage === 'shop'" class="page shop-page">
                <div class="shop-header">
                    <button class="back-btn" @click="currentPage = 'home'">
                        <i class="icon-arrow-left"></i>
                    </button>
                    <h3>Магазин</h3>
                </div>

                <div class="shop-tabs">
                    <button :class="{active: shopTab === 'nova'}" @click="shopTab = 'nova'">
                        $NOVA
                    </button>
                    <button :class="{active: shopTab === 'tix'}" @click="shopTab = 'tix'">
                        $TIX
                    </button>
                    <button :class="{active: shopTab === 'limited'}" @click="shopTab = 'limited'">
                        Лимитированные
                    </button>
                </div>

                <div class="shop-items">
                    <div v-for="item in filteredShopItems" :key="item.id" class="shop-item glass">
                        <div class="item-image">
                            <i :class="item.icon"></i>
                        </div>
                        <div class="item-info">
                            <div class="item-name">{{ item.name }}</div>
                            <div class="item-description">{{ item.description }}</div>
                            <div v-if="item.limited" class="item-timer">
                                <i class="icon-clock"></i> {{ item.timeLeft }}
                            </div>
                        </div>
                        <button class="buy-btn" @click="buyItem(item)" 
                                :disabled="user.nova_balance < item.price">
                            {{ item.price }}❇️
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav glass">
            <button :class="{active: currentPage === 'home'}" @click="currentPage = 'home'">
                <i class="icon-home"></i>
                <span>Главная</span>
            </button>
            <button :class="{active: currentPage === 'ai'}" @click="currentPage = 'ai'">
                <i class="icon-ai"></i>
                <span>Нейросети</span>
            </button>
            <button :class="{active: currentPage === 'starmap'}" @click="currentPage = 'starmap'">
                <i class="icon-map"></i>
                <span>StarMap</span>
            </button>
            <button :class="{active: currentPage === 'shop'}" @click="currentPage = 'shop'">
                <i class="icon-shop"></i>
                <span>Магазин</span>
            </button>
        </nav>

        <!-- Modals -->
        <!-- Gift Modal -->
        <div v-if="modalOpen === 'gift'" class="modal-overlay" @click.self="closeModal">
            <div class="modal-content glass">
                <div class="modal-header">
                    <h3>Подарить валюту</h3>
                    <button class="close-btn" @click="closeModal">
                        <i class="icon-close"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="currency-tabs">
                        <button :class="{active: giftCurrency === 'nova'}" 
                                @click="giftCurrency = 'nova'">
                            $NOVA
                        </button>
                        <button :class="{active: giftCurrency === 'tix'}" 
                                @click="giftCurrency = 'tix'">
                            $TIX
                        </button>
                    </div>
                    <div class="input-group">
                        <input type="number" v-model="giftAmount" :placeholder="'Сумма ' + (giftCurrency === 'nova' ? '❇️' : '✴️')">
                    </div>
                    <div class="member-search">
                        <input type="text" v-model="memberSearch" placeholder="Найти участника">
                        <div class="search-results">
                            <div v-for="member in filteredMembers" :key="member.id" 
                                 class="member-result" @click="selectGiftRecipient(member)">
                                <div class="member-avatar" 
                                     :style="{'background': getAvatarColor(member.avatar_color)}">
                                    {{ member.name.charAt(0) }}
                                </div>
                                <div class="member-name">{{ member.name }}</div>
                                <div class="member-username">{{ member.username }}</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn primary confirm-btn" @click="sendGift" 
                            :disabled="!giftRecipient || !giftAmount || 
                                     (giftCurrency === 'nova' && giftAmount > user.nova_balance) ||
                                     (giftCurrency === 'tix' && giftAmount > user.tix_balance)">
                        Отправить подарок
                    </button>
                </div>
            </div>
        </div>

        <!-- Exchange Modal -->
        <div v-if="modalOpen === 'exchange'" class="modal-overlay" @click.self="closeModal">
            <div class="modal-content glass">
                <div class="modal-header">
                    <h3>Обмен валюты</h3>
                    <button class="close-btn" @click="closeModal">
                        <i class="icon-close"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="currency-tabs">
                        <button :class="{active: exchangeFrom === 'nova'}" 
                                @click="exchangeFrom = 'nova'; exchangeTo = 'tix'">
                            $NOVA → $TIX
                        </button>
                        <button :class="{active: exchangeFrom === 'tix'}" 
                                @click="exchangeFrom = 'tix'; exchangeTo = 'nova'">
                            $TIX → $NOVA
                        </button>
                    </div>
                    <div class="input-group">
                        <input type="number" v-model="exchangeAmount" 
                               :placeholder="'Сумма ' + (exchangeFrom === 'nova' ? '❇️' : '✴️')">
                    </div>
                    <div class="exchange-rate">
                        <div class="rate-info">
                            Курс: 1✴️ = 10000❇️
                        </div>
                        <div class="result-amount">
                            Получите: {{ exchangeResult }} {{ exchangeTo === 'nova' ? '❇️' : '✴️' }}
                        </div>
                    </div>
                    <button class="btn primary confirm-btn" @click="confirmExchange" 
                            :disabled="!exchangeAmount || 
                                     (exchangeFrom === 'nova' && exchangeAmount > user.nova_balance) ||
                                     (exchangeFrom === 'tix' && exchangeAmount > user.tix_balance)">
                        Подтвердить обмен
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                // User data
                const user = ref({
                    id: null,
                    name: '',
                    username: '',
                    nova_balance: 0,
                    tix_balance: 0,
                    avatar_color: 'orange',
                    location_allowed: false,
                    steps: 0,
                    points: 0
                });

                // App state
                const currentPage = ref('home');
                const profileMenuOpen = ref(false);
                const modalOpen = ref(null);
                const sortDropdownOpen = ref(false);
                const selectedSort = ref(0);
                const sidebarOpen = ref(false);
                const locationAllowed = ref(false);
                const stepsRankingOpen = ref(false);
                const pointsListOpen = ref(false);
                const profileStatsOpen = ref(false);
                const shopTab = ref('nova');
                const map = ref(null);
                const userMarker = ref(null);
                const pointsMarkers = ref([]);
                const membersMarkers = ref([]);

                // Data
                const members = ref([]);
                const aiModels = ref([
                    { id: 1, name: 'GPT-4o', icon: 'icon-text', cost: 0 },
                    { id: 2, name: 'YaART Image', icon: 'icon-image', cost: 10 },
                    { id: 3, name: 'YaART Video', icon: 'icon-video', cost: 30 },
                    { id: 4, name: 'Sora Pro', icon: 'icon-video-pro', cost: 100 }
                ]);
                const currentAIModel = ref('GPT-4o');
                const aiChats = ref([]);
                const currentChat = ref(null);
                const currentMessages = ref([]);
                const stepsRanking = ref([]);
                const userPoints = ref([]);
                const collectedPoints = ref([]);
                const stats = ref({
                    steps: 0,
                    points: 0,
                    nova_earned: 0,
                    ranking: 0
                });
                const shopItems = ref([]);
                const stepsPeriod = ref('day');
                const statsPeriod = ref('day');

                // Form data
                const gptPrompt = ref('');
                const reportLink = ref('');
                const reportResult = ref(null);
                const aiPrompt = ref('');
                const imageFormat = ref('horizontal');
                const imageStyle = ref('default');
                const videoLength = ref('5');
                const giftCurrency = ref('nova');
                const giftAmount = ref('');
                const giftRecipient = ref(null);
                const memberSearch = ref('');
                const exchangeFrom = ref('nova');
                const exchangeTo = ref('tix');
                const exchangeAmount = ref('');

                // Socket connection
                const socket = io();

                // Initialize the app
                onMounted(() => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const userId = urlParams.get('user_id');
                    
                    if (userId) {
                        user.value.id = userId;
                        socket.emit('authenticate', userId);
                    }

                    // Load initial data
                    fetchInitialData();
                });

                // Computed properties
                const sortedMembers = computed(() => {
                    const sortOption = sortOptions.value[selectedSort.value];
                    return [...members.value].sort((a, b) => {
                        if (sortOption.field === 'name') {
                            return sortOption.direction * a.name.localeCompare(b.name);
                        }
                        return sortOption.direction * (a[sortOption.field] - b[sortOption.field]);
                    });
                });

                const filteredMembers = computed(() => {
                    if (!memberSearch.value) return [];
                    const search = memberSearch.value.toLowerCase();
                    return members.value.filter(m => 
                        m.name.toLowerCase().includes(search) || 
                        m.username.toLowerCase().includes(search)
                    ).slice(0, 5);
                });

                const exchangeResult = computed(() => {
                    if (!exchangeAmount.value) return 0;
                    const amount = parseFloat(exchangeAmount.value);
                    if (exchangeFrom.value === 'nova') {
                        return (amount / 10000).toFixed(2);
                    } else {
                        return (amount * 10000).toFixed(0);
                    }
                });

                const filteredShopItems = computed(() => {
                    if (shopTab.value === 'limited') {
                        return shopItems.value.filter(item => item.limited);
                    }
                    return shopItems.value.filter(item => 
                        !item.limited && 
                        (shopTab.value === 'nova' ? item.currency === 'nova' : item.currency === 'tix')
                    );
                });

                // Methods
                const fetchInitialData = async () => {
                    try {
                        const response = await fetch(`/api/user/${user.value.id}`);
                        const data = await response.json();
                        user.value = { ...user.value, ...data.user };
                        members.value = data.members;
                        shopItems.value = data.shopItems;
                        aiChats.value = data.aiChats;
                        stepsRanking.value = data.stepsRanking;
                        userPoints.value = data.userPoints;
                        collectedPoints.value = data.collectedPoints;
                        stats.value = data.stats;
                    } catch (error) {
                        console.error('Error fetching initial data:', error);
                    }
                };

                const getAvatarColor = (color) => {
                    const colors = {
                        orange: 'linear-gradient(145deg, #FF6B35, #FF9E1F)',
                        purple: 'linear-gradient(145deg, #9B5DE5, #6A4C93)',
                        pink: 'linear-gradient(145deg, #F15BB5, #EF476F)',
                        blue: 'linear-gradient(145deg, #00BBF9, #00A8E8)',
                        green: 'linear-gradient(145deg, #4BB543, #2E8B57)'
                    };
                    return colors[color] || colors.orange;
                };

                const toggleProfileMenu = () => {
                    profileMenuOpen.value = !profileMenuOpen.value;
                };

                const logout = () => {
                    // Implement logout logic
                    window.location.href = '/logout';
                };

                const openModal = (modal) => {
                    modalOpen.value = modal;
                };

                const closeModal = () => {
                    modalOpen.value = null;
                    giftRecipient.value = null;
                    giftAmount.value = '';
                    exchangeAmount.value = '';
                };

                const toggleSortDropdown = () => {
                    sortDropdownOpen.value = !sortDropdownOpen.value;
                };

                const sortMembers = (index) => {
                    selectedSort.value = index;
                    sortDropdownOpen.value = false;
                };

                const sendToGPT = async () => {
                    if (!gptPrompt.value) return;
                    
                    try {
                        currentPage.value = 'ai';
                        currentAIModel.value = 'GPT-4o';
                        aiPrompt.value = gptPrompt.value;
                        gptPrompt.value = '';
                        
                        await nextTick();
                        sendAIRequest();
                    } catch (error) {
                        console.error('Error sending to GPT:', error);
                    }
                };

                const sendReport = async () => {
                    if (!reportLink.value || user.value.nova_balance < 5000) return;
                    
                    try {
                        const response = await fetch('/api/report', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                user_id: user.value.id,
                                link: reportLink.value
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            user.value.nova_balance += 1000; // 6000 - 5000 = +1000 net
                            reportResult.value = {
                                type: 'success',
                                message: '✅ Готово! Сообщили администраторам и вернули тебе 6000❇️ на баланс'
                            };
                        } else {
                            user.value.nova_balance -= 5000;
                            reportResult.value = {
                                type: 'error',
                                message: '😥 К сожалению (или к счастью) в этом сообщении нет нарушений'
                            };
                        }
                        
                        reportLink.value = '';
                        setTimeout(() => {
                            reportResult.value = null;
                        }, 5000);
                    } catch (error) {
                        console.error('Error sending report:', error);
                    }
                };

                const selectModel = (model) => {
                    currentAIModel.value = model.name;
                    sidebarOpen.value = false;
                };

                const newChat = () => {
                    currentChat.value = null;
                    currentMessages.value = [];
                    aiPrompt.value = '';
                };

                const loadChat = (chatId) => {
                    currentChat.value = chatId;
                    // Load chat messages from API
                    fetchChatMessages(chatId);
                };

                const fetchChatMessages = async (chatId) => {
                    try {
                        const response = await fetch(`/api/chat/${chatId}`);
                        const data = await response.json();
                        currentMessages.value = data.messages;
                        sidebarOpen.value = false;
                        
                        await nextTick();
                        scrollMessagesToBottom();
                    } catch (error) {
                        console.error('Error fetching chat messages:', error);
                    }
                };

                const sendAIRequest = async () => {
                    if (!aiPrompt.value) return;
                    if (currentAIModel.value !== 'GPT-4o' && user.value.tix_balance < getAICost()) return;
                    
                    const message = {
                        id: Date.now(),
                        role: 'user',
                        content: aiPrompt.value,
                        timestamp: new Date().toISOString()
                    };
                    
                    currentMessages.value.push(message);
                    scrollMessagesToBottom();
                    
                    // Deduct cost if not GPT-4o
                    if (currentAIModel.value !== 'GPT-4o') {
                        user.value.tix_balance -= getAICost();
                    }
                    
                    const aiResponse = {
                        id: Date.now() + 1,
                        role: 'ai',
                        content: 'Это имитация ответа AI. В реальном приложении здесь будет ответ от API нейросети.',
                        timestamp: new Date().toISOString()
                    };
                    
                    setTimeout(() => {
                        currentMessages.value.push(aiResponse);
                        scrollMessagesToBottom();
                    }, 1000);
                    
                    aiPrompt.value = '';
                };

                const getAICost = () => {
                    const model = aiModels.value.find(m => m.name === currentAIModel.value);
                    return model ? model.cost : 0;
                };

                const scrollMessagesToBottom = () => {
                    const container = document.querySelector('.ai-messages');
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                };

                const requestLocationAccess = () => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                locationAllowed.value = true;
                                user.value.location_allowed = true;
                                initMap(position);
                            },
                            (error) => {
                                console.error('Geolocation error:', error);
                                alert('Для работы StarMap необходимо разрешить доступ к геолокации');
                            }
                        );
                    } else {
                        alert('Геолокация не поддерживается вашим браузером');
                    }
                };

                const initMap = (position) => {
                    map.value = L.map('map-container').setView(
                        [position.coords.latitude, position.coords.longitude], 
                        15
                    );
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map.value);
                    
                    // Add user marker
                    userMarker.value = L.marker(
                        [position.coords.latitude, position.coords.longitude],
                        {
                            icon: L.divIcon({
                                className: 'user-marker',
                                html: `<div style="background: ${getAvatarColor(user.value.avatar_color)}">${user.value.name.charAt(0)}</div>`,
                                iconSize: [40, 40]
                            })
                        }
                    ).addTo(map.value);
                    
                    // Add points markers
                    userPoints.value.forEach(point => {
                        const marker = L.marker(
                            [point.lat, point.lng],
                            {
                                icon: L.divIcon({
                                    className: 'point-marker',
                                    html: '🌟',
                                    iconSize: [30, 30]
                                })
                            }
                        ).addTo(map.value);
                        
                        marker.bindPopup(`
                            <div class="point-popup">
                                <h4>Точка сбора</h4>
                                <p>${point.address}</p>
                                <p>До ${point.expires}</p>
                                <button onclick="app.navigateToPoint(${point.id})">Навигация</button>
                                ${point.distance < 50 ? `<button onclick="app.collectPoint(${point.id})">Собрать</button>` : ''}
                            </div>
                        `);
                        
                        pointsMarkers.value.push(marker);
                    });
                    
                    // Add members markers
                    members.value.forEach(member => {
                        if (member.location && member.location_allowed) {
                            const marker = L.marker(
                                [member.location.lat, member.location.lng],
                                {
                                    icon: L.divIcon({
                                        className: 'member-marker',
                                        html: `<div style="background: ${getAvatarColor(member.avatar_color)}">${member.name.charAt(0)}</div>`,
                                        iconSize: [35, 35]
                                    })
                                }
                            ).addTo(map.value);
                            
                            marker.bindPopup(`
                                <div class="member-popup">
                                    <h4>${member.name}</h4>
                                    <p>${member.username}</p>
                                    <p>Шагов сегодня: ${member.steps_today}</p>
                                    <button onclick="app.hideMember(${member.id})">Скрыть</button>
                                </div>
                            `);
                            
                            membersMarkers.value.push(marker);
                        }
                    });
                };

                const toggleStepsRanking = () => {
                    stepsRankingOpen.value = !stepsRankingOpen.value;
                    if (stepsRankingOpen.value) {
                        pointsListOpen.value = false;
                        profileStatsOpen.value = false;
                    }
                };

                const togglePointsList = () => {
                    pointsListOpen.value = !pointsListOpen.value;
                    if (pointsListOpen.value) {
                        stepsRankingOpen.value = false;
                        profileStatsOpen.value = false;
                    }
                };

                const toggleProfileStats = () => {
                    profileStatsOpen.value = !profileStatsOpen.value;
                    if (profileStatsOpen.value) {
                        stepsRankingOpen.value = false;
                        pointsListOpen.value = false;
                    }
                };

                const navigateToPoint = (pointId) => {
                    const point = userPoints.value.find(p => p.id === pointId);
                    if (point) {
                        const url = `https://www.google.com/maps/dir/?api=1&destination=${point.lat},${point.lng}`;
                        window.open(url, '_blank');
                    }
                };

                const collectPoint = async (pointId) => {
                    try {
                        const response = await fetch('/api/collect-point', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                user_id: user.value.id,
                                point_id: pointId
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            user.value.nova_balance += result.reward;
                            user.value.points += 1;
                            
                            // Update points lists
                            const pointIndex = userPoints.value.findIndex(p => p.id === pointId);
                            if (pointIndex !== -1) {
                                const collectedPoint = userPoints.value.splice(pointIndex, 1)[0];
                                collectedPoint.reward = result.reward;
                                collectedPoints.value.unshift(collectedPoint);
                            }
                            
                            // Remove marker from map
                            const markerIndex = pointsMarkers.value.findIndex(m => m.pointId === pointId);
                            if (markerIndex !== -1) {
                                map.value.removeLayer(pointsMarkers.value[markerIndex]);
                                pointsMarkers.value.splice(markerIndex, 1);
                            }
                        }
                    } catch (error) {
                        console.error('Error collecting point:', error);
                    }
                };

                const hideMember = (memberId) => {
                    // Implement hide member logic
                    console.log('Hide member:', memberId);
                };

                const selectGiftRecipient = (member) => {
                    giftRecipient.value = member;
                    memberSearch.value = '';
                };

                const sendGift = async () => {
                    if (!giftRecipient.value || !giftAmount.value) return;
                    
                    try {
                        const response = await fetch('/api/send-gift', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                sender_id: user.value.id,
                                recipient_id: giftRecipient.value.id,
                                amount: parseFloat(giftAmount.value),
                                currency: giftCurrency.value
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // Update sender balance
                            if (giftCurrency.value === 'nova') {
                                user.value.nova_balance -= parseFloat(giftAmount.value);
                            } else {
                                user.value.tix_balance -= parseFloat(giftAmount.value);
                            }
                            
                            alert(`🎉 Вы подарили ${giftAmount.value}${giftCurrency.value === 'nova' ? '❇️' : '✴️'} пользователю ${giftRecipient.value.name}!`);
                            closeModal();
                        } else {
                            alert(result.message || 'Ошибка при отправке подарка');
                        }
                    } catch (error) {
                        console.error('Error sending gift:', error);
                        alert('Ошибка при отправке подарка');
                    }
                };

                const confirmExchange = async () => {
                    if (!exchangeAmount.value) return;
                    
                    try {
                        const response = await fetch('/api/exchange', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                user_id: user.value.id,
                                from: exchangeFrom.value,
                                to: exchangeTo.value,
                                amount: parseFloat(exchangeAmount.value)
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // Update balances
                            user.value[`${exchangeFrom.value}_balance`] -= parseFloat(exchangeAmount.value);
                            user.value[`${exchangeTo.value}_balance`] += parseFloat(exchangeResult.value);
                            
                            alert(`✅ Обмен выполнен успешно! Получено: ${exchangeResult.value}${exchangeTo.value === 'nova' ? '❇️' : '✴️'}`);
                            closeModal();
                        } else {
                            alert(result.message || 'Ошибка при обмене валюты');
                        }
                    } catch (error) {
                        console.error('Error exchanging currency:', error);
                        alert('Ошибка при обмене валюты');
                    }
                };

                const buyItem = async (item) => {
                    if (user.value.nova_balance < item.price) return;
                    
                    try {
                        const response = await fetch('/api/buy-item', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                user_id: user.value.id,
                                item_id: item.id
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            user.value.nova_balance -= item.price;
                            
                            if (item.currency === 'tix') {
                                user.value.tix_balance += item.tix_amount;
                                alert(`✅ Вы успешно купили ${item.tix_amount}✴️!`);
                            } else {
                                // Handle other item types (special abilities, etc.)
                                alert(`✅ ${item.name} успешно приобретен!`);
                            }
                        } else {
                            alert(result.message || 'Ошибка при покупке товара');
                        }
                    } catch (error) {
                        console.error('Error buying item:', error);
                        alert('Ошибка при покупке товара');
                    }
                };

                // Socket events
                socket.on('connect', () => {
                    console.log('Connected to WebSocket server');
                    if (user.value.id) {
                        socket.emit('authenticate', user.value.id);
                    }
                });

                socket.on('disconnect', () => {
                    console.log('Disconnected from WebSocket server');
                });

                socket.on('balance_update', (data) => {
                    if (data.user_id === user.value.id) {
                        user.value.nova_balance = data.nova_balance;
                        user.value.tix_balance = data.tix_balance;
                    }
                });

                socket.on('new_point', (point) => {
                    if (user.value.location_allowed) {
                        userPoints.value.push(point);
                        
                        const marker = L.marker(
                            [point.lat, point.lng],
                            {
                                icon: L.divIcon({
                                    className: 'point-marker',
                                    html: '🌟',
                                    iconSize: [30, 30]
                                })
                            }
                        ).addTo(map.value);
                        
                        marker.bindPopup(`
                            <div class="point-popup">
                                <h4>Точка сбора</h4>
                                <p>${point.address}</p>
                                <p>До ${point.expires}</p>
                                <button onclick="app.navigateToPoint(${point.id})">Навигация</button>
                                ${point.distance < 50 ? `<button onclick="app.collectPoint(${point.id})">Собрать</button>` : ''}
                            </div>
                        `);
                        
                        pointsMarkers.value.push(marker);
                    }
                });

                socket.on('member_location', (member) => {
                    if (!user.value.location_allowed) return;
                    
                    const existingMarkerIndex = membersMarkers.value.findIndex(m => m.memberId === member.id);
                    
                    if (existingMarkerIndex !== -1) {
                        // Update existing marker
                        membersMarkers.value[existingMarkerIndex]
                            .setLatLng([member.location.lat, member.location.lng]);
                    } else {
                        // Add new marker
                        const marker = L.marker(
                            [member.location.lat, member.location.lng],
                            {
                                icon: L.divIcon({
                                    className: 'member-marker',
                                    html: `<div style="background: ${getAvatarColor(member.avatar_color)}">${member.name.charAt(0)}</div>`,
                                    iconSize: [35, 35]
                                })
                            }
                        ).addTo(map.value);
                        
                        marker.bindPopup(`
                            <div class="member-popup">
                                <h4>${member.name}</h4>
                                <p>${member.username}</p>
                                <p>Шагов сегодня: ${member.steps_today}</p>
                                <button onclick="app.hideMember(${member.id})">Скрыть</button>
                            </div>
                        `);
                        
                        membersMarkers.value.push({
                            ...marker,
                            memberId: member.id
                        });
                    }
                });

                return {
                    // State
                    user,
                    currentPage,
                    profileMenuOpen,
                    modalOpen,
                    sortDropdownOpen,
                    selectedSort,
                    sidebarOpen,
                    locationAllowed,
                    stepsRankingOpen,
                    pointsListOpen,
                    profileStatsOpen,
                    shopTab,
                    
                    // Data
                    members,
                    aiModels,
                    currentAIModel,
                    aiChats,
                    currentChat,
                    currentMessages,
                    stepsRanking,
                    userPoints,
                    collectedPoints,
                    stats,
                    shopItems,
                    stepsPeriod,
                    statsPeriod,
                    
                    // Form data
                    gptPrompt,
                    reportLink,
                    reportResult,
                    aiPrompt,
                    imageFormat,
                    imageStyle,
                    videoLength,
                    giftCurrency,
                    giftAmount,
                    giftRecipient,
                    memberSearch,
                    exchangeFrom,
                    exchangeTo,
                    exchangeAmount,
                    
                    // Computed
                    sortedMembers,
                    filteredMembers,
                    exchangeResult,
                    filteredShopItems,
                    
                    // Methods
                    getAvatarColor,
                    toggleProfileMenu,
                    logout,
                    openModal,
                    closeModal,
                    toggleSortDropdown,
                    sortMembers,
                    sendToGPT,
                    sendReport,
                    selectModel,
                    newChat,
                    loadChat,
                    sendAIRequest,
                    getAICost,
                    requestLocationAccess,
                    toggleStepsRanking,
                    togglePointsList,
                    toggleProfileStats,
                    navigateToPoint,
                    collectPoint,
                    hideMember,
                    selectGiftRecipient,
                    sendGift,
                    confirmExchange,
                    buyItem
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
